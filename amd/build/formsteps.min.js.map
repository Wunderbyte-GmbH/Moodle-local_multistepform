{"version":3,"file":"formsteps.min.js","sources":["../src/formsteps.js"],"sourcesContent":["/**\n * JS for handling AJAX-based form step loading.\n *\n * @module local_multistepform/formsteps\n * @copyright 2025\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import Ajax from 'core/ajax';\nimport * as notification from 'core/notification';\nimport DynamicForm from 'core_form/dynamicform';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\n\nconst SELECTORS = {\n    FORMCONTAINER: '[data-region=multistepformcontainer]',\n    MULTISTEPFORMCONTAINER: 'div.multistep-form-wrapper',\n};\n\nvar dynamicForm = null;\nvar currentstep = 0;\nvar previousstep = 0;\n\nexport const init = (uniqueid, recordid, initialstep, formclass, data) => {\n\n    // eslint-disable-next-line no-console\n    console.log(data);\n\n    const multiformcontainer = document.querySelector(\n        SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    if (!multiformcontainer) {\n        return;\n    }\n\n    const formdata = data ? JSON.parse(data) : [];\n\n    currentstep = initialstep;\n\n    multiformcontainer.querySelectorAll('[data-step]').forEach(button => {\n        button.addEventListener('click', e => {\n\n            const direction = e.currentTarget.getAttribute('data-step');\n\n            previousstep = currentstep > 0 ? currentstep : previousstep;\n            switch (direction) {\n                case 'next':\n                    currentstep++;\n                    break;\n                case 'previous':\n                    if (currentstep < 0) {\n                        // If we are on the review page, we fake steps in a way that..\n                        // .. we land on the last page and previous page is set to last but one.\n                        currentstep = previousstep;\n                    } else {\n                        currentstep--;\n                    }\n                    break;\n                case 'submit':\n                    currentstep = -1;\n                    break;\n                default:\n                    currentstep = -2;\n                    break;\n            }\n\n            if (!dynamicForm) {\n                loadStep(uniqueid, recordid, currentstep);\n            } else {\n                dynamicForm.submitFormAjax().then(() => {\n                    return true;\n                }).catch(e => {\n                    // eslint-disable-next-line no-console\n                    console.log(e);\n                });\n            }\n        });\n    });\n    const container = multiformcontainer.querySelector(SELECTORS.FORMCONTAINER);\n\n    initializeForm(container, formclass, formdata);\n};\n\n/**\n * Load a step of the form via AJAX.\n *\n * @param {mixed} uniqueid\n * @param {mixed} recordid\n * @param {mixed} step\n *\n * @return void *\n */\nfunction loadStep(uniqueid, recordid, step) {\n    const multiformcontainer = document.querySelector(\n        SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    if (!multiformcontainer) {\n        return;\n    }\n    const container = multiformcontainer.querySelector(SELECTORS.FORMCONTAINER);\n    const topwrapper = multiformcontainer.closest('.multiform-container-topwrapper');\n    container.classList.remove('fade-in');\n    void container.offsetWidth;\n    container.classList.add('fade-out');\n\n    const onFadeOutEnd = () => {\n        container.removeEventListener('transitionend', onFadeOutEnd);\n        setTimeout(() => {\n            if (step > 0) {\n            dynamicForm = null;\n            }\n        }, 300);// Reset dynamicForm to ensure a fresh start\n        // Step 3: Load next step content\n        Ajax.call([{\n            methodname: 'local_multistepform_load_step',\n            args: { uniqueid, recordid, step },\n            done: response => {\n                if (response.returnurl?.length > 0) {\n                    window.location.href = response.returnurl;\n                    return;\n                }\n\n                Templates.renderForPromise(response.template, JSON.parse(response.data)).then(({ html, js }) => {\n                    // Prepare new content\n                    const tempWrapper = document.createElement('div');\n                    tempWrapper.innerHTML = html;\n\n                    Templates.runTemplateJS(js, tempWrapper);\n\n                    const newFormContainer = tempWrapper.querySelector(SELECTORS.FORMCONTAINER);\n                    const formclass = tempWrapper.querySelector('[data-formclass]')?.getAttribute('data-formclass');\n\n                    if (formclass && newFormContainer) {\n                        initializeForm(newFormContainer, formclass, []);\n                    }\n\n                    // Step 4: Replace the content\n                    topwrapper.innerHTML = '';\n                    topwrapper.appendChild(tempWrapper.firstElementChild);\n\n                    // Step 5: Trigger fade-in\n                    requestAnimationFrame(() => {\n                        newFormContainer.classList.remove('fade-out');\n                        newFormContainer.classList.add('fade-in');\n                    });\n\n                }).catch(notification.exception);\n            },\n            fail: notification.exception\n        }]);\n    };\n\n    // Attach the fade-out end listener\n    container.addEventListener('transitionend', onFadeOutEnd, { once: true });\n}\n\n/**\n * Initialize the form with a template and data.\n *\n * @param {mixed} container\n * @param {mixed} formclass\n * @param {array} data\n *\n * @return [type]\n *\n */\nfunction initializeForm(container, formclass, data = []) {\n\n    if (container) {\n            container.parentElement.addEventListener('click', e => {\n\n            const target = e.target;\n            if (\n                target.tagName === 'INPUT' &&\n                target.type === 'submit' &&\n                (\n                    target.name.startsWith('target_add') ||\n                    target.name.startsWith('deleteelement')\n                )\n            ) {\n               loadAutocompleteElements();\n            }\n        });\n    }\n\n    const uniqueid = container?.closest(SELECTORS.MULTISTEPFORMCONTAINER)?.getAttribute('data-uniqueid') ?? '';\n    const recordid = container?.closest(SELECTORS.MULTISTEPFORMCONTAINER)?.getAttribute('data-recordid') ?? '';\n\n    if (!dynamicForm && uniqueid.length > 0) {\n\n        dynamicForm = new DynamicForm(\n            container,\n            formclass,\n            data,\n        );\n\n        if (dynamicForm) {\n            dynamicForm.addEventListener(dynamicForm.events.FORM_SUBMITTED, () => {\n\n                loadStep(uniqueid, recordid, currentstep);\n            });\n\n            dynamicForm.addEventListener(dynamicForm.events.SERVER_VALIDATION_ERROR, () => {\n\n                // When we tried to go to the previous page, even when the validation fails, we load the step.\n                if ((currentstep + 1) == previousstep) {\n                    loadStep(uniqueid, recordid, currentstep);\n                } else {\n                    currentstep = previousstep;\n                }\n            });\n        }\n\n        loadAutocompleteElements();\n    }\n}\n\n/**\n * Make sure all autocomplete elements are loaded.\n *\n * @return void\n *\n */\nfunction loadAutocompleteElements() {\n// Wait for DOM to update after Moodle repeats the form elements\n    window.requestAnimationFrame(() => {\n        // eslint-disable-next-line no-console\n        console.log('make sure all autocomplete elements are here');\n        setTimeout(() => {\n            // eslint-disable-next-line no-console\n            console.log('load them now');\n            require(['core/form-autocomplete'], (AutoComplete) => {\n                document.querySelectorAll('div[data-fieldtype=\"autocomplete\"]').forEach((select) => {\n                    const alreadyEnhanced = select.querySelector('.form-autocomplete-downarrow');\n\n                    if (!alreadyEnhanced && AutoComplete.enhance) {\n                        AutoComplete.enhance(select.querySelector('select'));\n                    }\n                });\n            });\n            const packageSelect = document.querySelector('#id_message_package');\n            if (packageSelect) {\n                packageSelect.addEventListener('change', (e) => {\n                const selectedPackageId = e.target.value;\n                e.stopImmediatePropagation();\n\n                // Deselect all selected messageids.\n                const messageSelect = document.querySelector('#id_messageids');\n                if (messageSelect) {\n                    Array.from(messageSelect.options).forEach(option => {\n                        option.selected = false;\n                    });\n                }\n\n                if (dynamicForm) {\n                    dynamicForm.submitFormAjax({\n                        packageid: selectedPackageId\n                    }).then(() => {\n                        // The form will be reloaded by SERVER_VALIDATION_ERROR below.\n                        return;\n                    }).catch(err => {\n                        // eslint-disable-next-line no-console\n                        console.error(err);\n                    });\n                }\n                });\n            }\n        }, 400);\n    });\n}"],"names":["SELECTORS","dynamicForm","currentstep","previousstep","loadStep","uniqueid","recordid","step","multiformcontainer","document","querySelector","container","topwrapper","closest","classList","remove","offsetWidth","add","onFadeOutEnd","removeEventListener","setTimeout","call","methodname","args","done","response","returnurl","length","window","location","href","renderForPromise","template","JSON","parse","data","then","_ref","html","js","tempWrapper","createElement","innerHTML","runTemplateJS","newFormContainer","formclass","_tempWrapper$querySel","getAttribute","initializeForm","appendChild","firstElementChild","requestAnimationFrame","catch","notification","exception","fail","addEventListener","once","parentElement","e","target","tagName","type","name","startsWith","loadAutocompleteElements","DynamicForm","events","FORM_SUBMITTED","SERVER_VALIDATION_ERROR","console","log","require","AutoComplete","querySelectorAll","forEach","select","enhance","packageSelect","selectedPackageId","value","stopImmediatePropagation","messageSelect","Array","from","options","option","selected","submitFormAjax","packageid","err","error","initialstep","formdata","button","direction","currentTarget"],"mappings":"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"}