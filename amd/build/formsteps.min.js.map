{"version":3,"file":"formsteps.min.js","sources":["../src/formsteps.js"],"sourcesContent":["/**\n * JS for handling AJAX-based form step loading.\n *\n * @module local_multistepform/formsteps\n * @copyright 2025\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import Ajax from 'core/ajax';\nimport * as notification from 'core/notification';\nimport DynamicForm from 'core_form/dynamicform';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\n\nconst SELECTORS = {\n    FORMCONTAINER: '[data-region=multistepformcontainer]',\n    MULTISTEPFORMCONTAINER: 'div.multistep-form-wrapper',\n};\n\nvar dynamicForm = null;\nvar currentstep = 0;\nvar previousstep = 0;\n\nexport const init = (uniqueid, recordid, initialstep, formclass, data) => {\n\n    // eslint-disable-next-line no-console\n    console.log(data);\n\n    const multiformcontainer = document.querySelector(\n        SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    if (!multiformcontainer) {\n        return;\n    }\n\n    const formdata = data ? JSON.parse(data) : [];\n\n    currentstep = initialstep;\n\n    multiformcontainer.querySelectorAll('[data-step]').forEach(button => {\n        button.addEventListener('click', e => {\n\n            const direction = e.currentTarget.getAttribute('data-step');\n\n            previousstep = currentstep > 0 ? currentstep : previousstep;\n            switch (direction) {\n                case 'next':\n                    currentstep++;\n                    break;\n                case 'previous':\n                    if (currentstep < 0) {\n                        // If we are on the review page, we fake steps in a way that..\n                        // .. we land on the last page and previous page is set to last but one.\n                        currentstep = previousstep;\n                    } else {\n                        currentstep--;\n                    }\n                    break;\n                case 'submit':\n                    currentstep = -1;\n                    break;\n                default:\n                    currentstep = -2;\n                    break;\n            }\n\n            if (!dynamicForm) {\n                loadStep(uniqueid, recordid, currentstep);\n            } else {\n                dynamicForm.submitFormAjax().then(() => {\n                    return true;\n                }).catch(e => {\n                    // eslint-disable-next-line no-console\n                    console.log(e);\n                });\n            }\n        });\n    });\n    const container = multiformcontainer.querySelector(SELECTORS.FORMCONTAINER);\n\n    initializeForm(container, formclass, formdata);\n};\n\n/**\n * Load a step of the form via AJAX.\n *\n * @param {mixed} uniqueid\n * @param {mixed} recordid\n * @param {mixed} step\n *\n * @return void *\n */\nfunction loadStep(uniqueid, recordid, step) {\n    const multiformcontainer = document.querySelector(\n        SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    if (!multiformcontainer) {\n        return;\n    }\n\n    Ajax.call([{\n        methodname: 'local_multistepform_load_step',\n        args: {\n            uniqueid: uniqueid,\n            recordid: recordid,\n            step: step,\n        },\n        done: (response) => {\n\n            if (response.returnurl.length > 0) {\n                window.location.href = response.returnurl;\n                return;\n            }\n\n            Templates.renderForPromise(response.template, JSON.parse(response.data)).then(({html, js}) => {\n                // We add the footer js to the html.\n                html = html + response.js;\n                Templates.replaceNode(SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]', html, js);\n\n                return true;\n            }).catch(e => {\n                // eslint-disable-next-line no-console\n                console.log(e);\n            });\n        },\n        fail: (error) => {\n            notification.exception(error);\n        },\n    }]);\n}\n\n/**\n * Initialize the form with a template and data.\n *\n * @param {mixed} container\n * @param {mixed} formclass\n * @param {array} data\n *\n * @return [type]\n *\n */\nfunction initializeForm(container, formclass, data = []) {\n\n    if (container) {\n            container.parentElement.addEventListener('click', e => {\n\n            const target = e.target;\n            // eslint-disable-next-line no-console\n            console.log('!&!&!&!&!&!&!&!&!&', target);\n            if (\n                target.tagName === 'INPUT' &&\n                target.type === 'submit' &&\n                (\n                    target.name.startsWith('target_add') ||\n                    target.name.startsWith('deleteelement')\n                )\n            ) {\n               loadAutocompleteElements();\n            }\n        });\n    }\n\n    const uniqueid = container?.closest(SELECTORS.MULTISTEPFORMCONTAINER)?.getAttribute('data-uniqueid') ?? '';\n    const recordid = container?.closest(SELECTORS.MULTISTEPFORMCONTAINER)?.getAttribute('data-recordid') ?? '';\n\n    if (!dynamicForm && uniqueid.length > 0) {\n\n        dynamicForm = new DynamicForm(\n            container,\n            formclass,\n            data,\n        );\n\n        if (dynamicForm) {\n            dynamicForm.addEventListener(dynamicForm.events.FORM_SUBMITTED, () => {\n                dynamicForm = null;\n\n                loadStep(uniqueid, recordid, currentstep);\n            });\n\n            dynamicForm.addEventListener(dynamicForm.events.SERVER_VALIDATION_ERROR, () => {\n\n                // When we tried to go to the previous page, even when the validation fails, we load the step.\n                if ((currentstep + 1) == previousstep) {\n                    dynamicForm = null;\n                    loadStep(uniqueid, recordid, currentstep);\n                } else {\n                    currentstep = previousstep;\n                }\n            });\n        }\n\n        loadAutocompleteElements();\n    }\n}\n\n/**\n * Make sure all autocomplete elements are loaded.\n *\n * @return void\n *\n */\nfunction loadAutocompleteElements() {\n// Wait for DOM to update after Moodle repeats the form elements\n    window.requestAnimationFrame(() => {\n        // eslint-disable-next-line no-console\n        console.log('make sure all autocomplete elements are here');\n        setTimeout(() => {\n            // eslint-disable-next-line no-console\n            console.log('load them now');\n            require(['core/form-autocomplete'], (AutoComplete) => {\n                document.querySelectorAll('div[data-fieldtype=\"autocomplete\"]').forEach((select) => {\n                    const alreadyEnhanced = select.querySelector('.form-autocomplete-downarrow');\n\n                    if (!alreadyEnhanced && AutoComplete.enhance) {\n                        AutoComplete.enhance(select.querySelector('select'));\n                    }\n                });\n            });\n            const packageSelect = document.querySelector('#id_message_package');\n            if (packageSelect) {\n                packageSelect.addEventListener('change', (e) => {\n                const selectedPackageId = e.target.value;\n                e.stopImmediatePropagation();\n\n                // Deselect all selected messageids.\n                const messageSelect = document.querySelector('#id_messageids');\n                if (messageSelect) {\n                    Array.from(messageSelect.options).forEach(option => {\n                        option.selected = false;\n                    });\n                }\n\n                if (dynamicForm) {\n                    dynamicForm.submitFormAjax({\n                        packageid: selectedPackageId\n                    }).then(() => {\n                        // The form will be reloaded by SERVER_VALIDATION_ERROR below.\n                        return;\n                    }).catch(err => {\n                        // eslint-disable-next-line no-console\n                        console.error(err);\n                    });\n                }\n                });\n            }\n        }, 400);\n    });\n}"],"names":["_interopRequireDefault","e","__esModule","default","_getRequireWildcardCache","WeakMap","r","t","notification","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireWildcard","_dynamicform","_ajax","_templates","SELECTORS","dynamicForm","currentstep","previousstep","loadStep","uniqueid","recordid","step","document","querySelector","Ajax","methodname","args","done","response","returnurl","length","window","location","href","Templates","renderForPromise","template","JSON","parse","data","then","_ref","html","js","replaceNode","catch","console","log","fail","error","exception","loadAutocompleteElements","requestAnimationFrame","setTimeout","require","AutoComplete","querySelectorAll","forEach","select","enhance","packageSelect","addEventListener","selectedPackageId","target","value","stopImmediatePropagation","messageSelect","Array","from","options","option","selected","submitFormAjax","packageid","err","_exports","init","initialstep","formclass","multiformcontainer","formdata","button","direction","currentTarget","getAttribute","container","arguments","undefined","parentElement","tagName","type","name","startsWith","closest","DynamicForm","events","FORM_SUBMITTED","SERVER_VALIDATION_ERROR","initializeForm"],"mappings":"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"}