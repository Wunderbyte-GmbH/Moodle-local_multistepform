{"version":3,"file":"formsteps.min.js","sources":["../src/formsteps.js"],"sourcesContent":["/**\n * JS for handling AJAX-based form step loading.\n *\n * @module local_multistepform/formsteps\n * @copyright 2025\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import Ajax from 'core/ajax';\nimport * as notification from 'core/notification';\nimport DynamicForm from 'core_form/dynamicform';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\n\nconst SELECTORS = {\n    FORMCONTAINER: '[data-region=multistepformcontainer]',\n    MULTISTEPFORMCONTAINER: 'div.multistep-form-wrapper',\n};\n\nvar dynamicForms = {};\nvar currentstep = 1;\nvar previousstep = 0;\n\nexport const init = (uniqueid, recordid, initialstep, formclass, data) => {\n\n    const multiformcontainer = document.querySelector(\n        SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    if (!multiformcontainer) {\n        return;\n    }\n\n    const formdata = data ? JSON.parse(data) : [];\n\n    currentstep = initialstep;\n\n    multiformcontainer.querySelectorAll('[data-step]').forEach(button => {\n        button.addEventListener('click', e => {\n            const direction = e.currentTarget.getAttribute('data-step');\n\n            const oldstep = currentstep; // Save current before changing\n\n            switch (direction) {\n                case 'next':\n                    currentstep++;\n                    break;\n                case 'previous':\n                    // If we're on a review step or invalid step, go back to last known valid\n                    currentstep = currentstep < 0 ? previousstep : currentstep - 1;\n                    break;\n                case 'submit':\n                    currentstep = -1;\n                    break;\n                default:\n                    currentstep = -2;\n                    break;\n            }\n\n            previousstep = oldstep;\n            const form = dynamicForms[oldstep];\n            if (form) {\n                form.submitFormAjax().then(() => {\n                    return true;\n                }).catch(e => {\n                    notification.exception(e);\n                });\n            } else {\n                loadStep(uniqueid, recordid, currentstep);\n            }\n        });\n    });\n    const container = multiformcontainer.querySelector(SELECTORS.FORMCONTAINER);\n\n    initializeForm(container, formclass, formdata);\n};\n\n/**\n * Load a step of the form via AJAX.\n *\n * @param {mixed} uniqueid\n * @param {mixed} recordid\n * @param {mixed} step\n *\n * @return void *\n */\nfunction loadStep(uniqueid, recordid, step) {\n    const multiformcontainer = document.querySelector(\n        SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    if (!multiformcontainer) {\n        return;\n    }\n    const container = multiformcontainer.querySelector(SELECTORS.FORMCONTAINER) || multiformcontainer;\n    container.classList.remove('fade-in');\n    void container.offsetWidth;\n    container.classList.add('fade-out');\n    Ajax.call([{\n        methodname: 'local_multistepform_load_step',\n        args: {\n            uniqueid: uniqueid,\n            recordid: recordid,\n            step: step,\n        },\n        done: (response) => {\n\n            if (response.returnurl.length > 0) {\n                window.location.href = response.returnurl;\n                return;\n            }\n\n            Templates.renderForPromise(response.template, JSON.parse(response.data)).then(({html, js}) => {\n                // We add the footer js to the html.\n                html = html + response.js;\n                Templates.replaceNode(SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]', html, js);\n                return true;\n            }).catch(e => {\n                // eslint-disable-next-line no-console\n                console.log(e);\n            });\n        },\n        fail: (error) => {\n            notification.exception(error);\n        },\n    }]);\n}\n\n/**\n * Initialize the form with a template and data.\n *\n * @param {mixed} container\n * @param {mixed} formclass\n * @param {array} data\n *\n * @return [type]\n *\n */\nfunction initializeForm(container, formclass, data = []) {\n\n    if (container) {\n            container.parentElement.addEventListener('click', e => {\n\n            const target = e.target;\n            if (\n                target.tagName === 'INPUT' &&\n                target.type === 'submit' &&\n                (\n                    target.name.startsWith('target_add') ||\n                    target.name.startsWith('deleteelement')\n                )\n            ) {\n               loadAutocompleteElements();\n            }\n        });\n    }\n\n    const uniqueid = container?.closest(SELECTORS.MULTISTEPFORMCONTAINER)?.getAttribute('data-uniqueid') ?? '';\n    const recordid = container?.closest(SELECTORS.MULTISTEPFORMCONTAINER)?.getAttribute('data-recordid') ?? '';\n\n    const alreadyInitialized = dynamicForms[currentstep]\n        && container.dataset.initializedStep == currentstep;\n\n    if (!alreadyInitialized && uniqueid.length > 0) {\n        dynamicForms[currentstep] = new DynamicForm(container, formclass, data);\n        container.dataset.initializedStep = currentstep;\n\n        const dynamicForm = dynamicForms[currentstep];\n\n        dynamicForm.addEventListener(dynamicForm.events.FORM_SUBMITTED, () => {\n            loadStep(uniqueid, recordid, currentstep);\n        });\n\n        dynamicForm.addEventListener(dynamicForm.events.SERVER_VALIDATION_ERROR, () => {\n            if ((currentstep + 1) === previousstep) {\n                loadStep(uniqueid, recordid, currentstep);\n            } else {\n                currentstep = previousstep;\n            }\n        });\n\n        loadAutocompleteElements();\n    }\n}\n\n/**\n * Make sure all autocomplete elements are loaded.\n *\n * @return void\n *\n */\nfunction loadAutocompleteElements() {\n    require(['core/form-autocomplete'], (AutoComplete) => {\n        // Enhance all uninitialized autocomplete fields\n        document.querySelectorAll('div[data-fieldtype=\"autocomplete\"]').forEach((select) => {\n            const alreadyEnhanced = select.querySelector('.form-autocomplete-downarrow');\n\n            if (!alreadyEnhanced && AutoComplete.enhance) {\n                const dropdown = select.querySelector('select');\n                if (dropdown) {\n                    AutoComplete.enhance(dropdown);\n                }\n            }\n        });\n    });\n\n    // Set up listener only once for package change\n    const packageSelect = document.querySelector('#id_message_package');\n    if (packageSelect && !packageSelect.dataset.listenerAttached) {\n        packageSelect.dataset.listenerAttached = 'true'; // Prevent duplicate listeners\n        packageSelect.addEventListener('change', (e) => {\n            const selectedPackageId = e.target.value;\n            e.stopImmediatePropagation();\n\n            // Deselect all messageids\n            const messageSelect = document.querySelector('#id_messageids');\n            if (messageSelect) {\n                Array.from(messageSelect.options).forEach(option => {\n                    option.selected = false;\n                });\n            }\n\n            if (dynamicForms[currentstep]) {\n                dynamicForms[currentstep].submitFormAjax({\n                    packageid: selectedPackageId\n                }).then(() => {\n                    // Form will reload through validation handler\n                }).catch(err => {\n                    notification.exception(err);\n                });\n            }\n        });\n    }\n}\n"],"names":["SELECTORS","dynamicForms","currentstep","previousstep","loadStep","uniqueid","recordid","step","multiformcontainer","document","querySelector","container","classList","remove","offsetWidth","add","call","methodname","args","done","response","returnurl","length","window","location","href","renderForPromise","template","JSON","parse","data","then","_ref","html","js","replaceNode","catch","e","console","log","fail","error","notification","exception","loadAutocompleteElements","require","AutoComplete","querySelectorAll","forEach","select","enhance","dropdown","packageSelect","dataset","listenerAttached","addEventListener","selectedPackageId","target","value","stopImmediatePropagation","messageSelect","Array","from","options","option","selected","submitFormAjax","packageid","err","initialstep","formclass","formdata","button","direction","currentTarget","getAttribute","oldstep","form","parentElement","tagName","type","name","startsWith","closest","initializedStep","DynamicForm","dynamicForm","events","FORM_SUBMITTED","SERVER_VALIDATION_ERROR","initializeForm"],"mappings":"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"}