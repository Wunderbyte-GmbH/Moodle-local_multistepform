{"version":3,"file":"formsteps.min.js","sources":["../src/formsteps.js"],"sourcesContent":["/**\n * JS for handling AJAX-based form step loading.\n *\n * @module local_multistepform/formsteps\n * @copyright 2025\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import Ajax from 'core/ajax';\nimport * as notification from 'core/notification';\nimport DynamicForm from 'core_form/dynamicform';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\n\nconst SELECTORS = {\n    FORMCONTAINER: '[data-region=multistepformcontainer]',\n    MULTISTEPFORMCONTAINER: 'div.multistep-form-wrapper',\n};\n\nvar dynamicForm = null;\nvar currentstep = 0;\nvar previousstep = 0;\n\nexport const init = (uniqueid, recordid, initialstep, formclass, data) => {\n\n    const multiformcontainer = document.querySelector(\n        SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    if (!multiformcontainer) {\n        return;\n    }\n\n    const formdata = data ? JSON.parse(data) : [];\n\n    currentstep = initialstep;\n\n    multiformcontainer.querySelectorAll('[data-step]').forEach(button => {\n        button.addEventListener('click', e => {\n\n            const direction = e.currentTarget.getAttribute('data-step');\n\n            previousstep = currentstep > 0 ? currentstep : previousstep;\n            switch (direction) {\n                case 'next':\n                    currentstep++;\n                    break;\n                case 'previous':\n                    if (currentstep < 0) {\n                        // If we are on the review page, we fake steps in a way that..\n                        // .. we land on the last page and previous page is set to last but one.\n                        currentstep = previousstep;\n                    } else {\n                        currentstep--;\n                    }\n                    break;\n                case 'submit':\n                    currentstep = -1;\n                    break;\n                default:\n                    currentstep = -2;\n                    break;\n            }\n\n            if (!dynamicForm) {\n                loadStep(uniqueid, recordid, currentstep);\n            } else {\n                dynamicForm.submitFormAjax().then(() => {\n                    return true;\n                }).catch(e => {\n                    // eslint-disable-next-line no-console\n                    console.log(e);\n                });\n            }\n        });\n    });\n    const container = multiformcontainer.querySelector(SELECTORS.FORMCONTAINER);\n\n    initializeForm(container, formclass, formdata);\n};\n\n/**\n * Load a step of the form via AJAX.\n *\n * @param {mixed} uniqueid\n * @param {mixed} recordid\n * @param {mixed} step\n *\n * @return void *\n */\nfunction loadStep(uniqueid, recordid, step) {\n    const multiformcontainer = document.querySelector(\n        SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    if (!multiformcontainer) {\n        return;\n    }\n\n    Ajax.call([{\n        methodname: 'local_multistepform_load_step',\n        args: {\n            uniqueid: uniqueid,\n            recordid: recordid,\n            step: step,\n        },\n        done: (response) => {\n\n            if (response.returnurl.length > 0) {\n                window.location.href = response.returnurl;\n                return;\n            }\n\n            Templates.renderForPromise(response.template, JSON.parse(response.data)).then(({html, js}) => {\n                // We add the footer js to the html.\n                html = html + response.js;\n                Templates.replaceNode(SELECTORS.MULTISTEPFORMCONTAINER + '[data-uniqueid=\"' + uniqueid + '\"]', html, js);\n\n                return true;\n            }).catch(e => {\n                // eslint-disable-next-line no-console\n                console.log(e);\n            });\n        },\n        fail: (error) => {\n            notification.exception(error);\n        },\n    }]);\n}\n\n/**\n * Initialize the form with a template and data.\n *\n * @param {mixed} container\n * @param {mixed} formclass\n * @param {array} data\n *\n * @return [type]\n *\n */\nfunction initializeForm(container, formclass, data = []) {\n    container.parentElement.addEventListener('click', e => {\n\n        const target = e.target;\n        if (\n            target.tagName === 'INPUT' &&\n            target.type === 'submit' &&\n            target.name.startsWith('target_add')\n        ) {\n            // Wait for DOM to update after Moodle repeats the form elements\n            window.requestAnimationFrame(() => {\n                setTimeout(() => {\n                    require(['core/form-autocomplete'], (AutoComplete) => {\n                        document.querySelectorAll('div[data-fieldtype=\"autocomplete\"]').forEach((select) => {\n                            const alreadyEnhanced = select.querySelector('.form-autocomplete-downarrow');\n\n                            if (!alreadyEnhanced && AutoComplete.enhance) {\n                                AutoComplete.enhance(select.querySelector('select'));\n                            }\n                        });\n                    });\n                }, 1000); // A small delay to ensure DOM is updated\n            });\n        }\n\n    });\n\n    const uniqueid = container?.closest(SELECTORS.MULTISTEPFORMCONTAINER)?.getAttribute('data-uniqueid') ?? '';\n    const recordid = container?.closest(SELECTORS.MULTISTEPFORMCONTAINER)?.getAttribute('data-recordid') ?? '';\n\n    if (!dynamicForm && uniqueid.length > 0) {\n\n        setTimeout(() => {\n            dynamicForm = new DynamicForm(\n                container,\n                formclass,\n                data,\n            );\n\n            if (dynamicForm) {\n                dynamicForm.addEventListener(dynamicForm.events.FORM_SUBMITTED, () => {\n                    dynamicForm = null;\n\n                    loadStep(uniqueid, recordid, currentstep);\n                });\n\n                dynamicForm.addEventListener(dynamicForm.events.SERVER_VALIDATION_ERROR, () => {\n\n                    // When we tried to go to the previous page, even when the validation fails, we load the step.\n                    if ((currentstep + 1) == previousstep) {\n                        dynamicForm = null;\n                        loadStep(uniqueid, recordid, currentstep);\n                    } else {\n                        currentstep = previousstep;\n                    }\n                });\n            }\n        }, 100);\n    }\n}"],"names":["SELECTORS","dynamicForm","currentstep","previousstep","loadStep","uniqueid","recordid","step","document","querySelector","call","methodname","args","done","response","returnurl","length","window","location","href","renderForPromise","template","JSON","parse","data","then","_ref","html","js","replaceNode","catch","e","console","log","fail","error","notification","exception","initialstep","formclass","multiformcontainer","formdata","querySelectorAll","forEach","button","addEventListener","direction","currentTarget","getAttribute","submitFormAjax","container","parentElement","target","tagName","type","name","startsWith","requestAnimationFrame","setTimeout","require","AutoComplete","select","enhance","closest","DynamicForm","events","FORM_SUBMITTED","SERVER_VALIDATION_ERROR","initializeForm"],"mappings":";;;;;;;8JAcMA,wBACa,uCADbA,iCAEsB,iCAGxBC,YAAc,KACdC,YAAc,EACdC,aAAe,WAmEVC,SAASC,SAAUC,SAAUC,MACPC,SAASC,cAChCT,iCAAmC,mBAAqBK,SAAW,qBAKlEK,KAAK,CAAC,CACPC,WAAY,gCACZC,KAAM,CACFP,SAAUA,SACVC,SAAUA,SACVC,KAAMA,MAEVM,KAAOC,WAECA,SAASC,UAAUC,OAAS,EAC5BC,OAAOC,SAASC,KAAOL,SAASC,6BAI1BK,iBAAiBN,SAASO,SAAUC,KAAKC,MAAMT,SAASU,OAAOC,MAAKC,WAACC,KAACA,KAADC,GAAOA,gBAElFD,MAAcb,SAASc,sBACbC,YAAY7B,iCAAmC,mBAAqBK,SAAW,KAAMsB,KAAMC,KAE9F,KACRE,OAAMC,IAELC,QAAQC,IAAIF,OAGpBG,KAAOC,QACHC,aAAaC,UAAUF,yBAlGf,CAAC9B,SAAUC,SAAUgC,YAAaC,UAAWf,cAEvDgB,mBAAqBhC,SAASC,cAChCT,iCAAmC,mBAAqBK,SAAW,UAClEmC,gCAICC,SAAWjB,KAAOF,KAAKC,MAAMC,MAAQ,GAE3CtB,YAAcoC,YAEdE,mBAAmBE,iBAAiB,eAAeC,SAAQC,SACvDA,OAAOC,iBAAiB,SAASd,UAEvBe,UAAYf,EAAEgB,cAAcC,aAAa,oBAE/C7C,aAAeD,YAAc,EAAIA,YAAcC,aACvC2C,eACC,OACD5C,wBAEC,WACGA,YAAc,EAGdA,YAAcC,aAEdD,wBAGH,SACDA,aAAe,gBAGfA,aAAe,EAIlBD,YAGDA,YAAYgD,iBAAiBxB,MAAK,KACvB,IACRK,OAAMC,IAELC,QAAQC,IAAIF,MANhB3B,SAASC,SAAUC,SAAUJ,6BAyErBgD,UAAWX,0DAAWf,4DAAO,GACjD0B,UAAUC,cAAcN,iBAAiB,SAASd,UAExCqB,OAASrB,EAAEqB,OAEM,UAAnBA,OAAOC,SACS,WAAhBD,OAAOE,MACPF,OAAOG,KAAKC,WAAW,eAGvBvC,OAAOwC,uBAAsB,KACzBC,YAAW,KACPC,QAAQ,CAAC,2BAA4BC,eACjCpD,SAASkC,iBAAiB,sCAAsCC,SAASkB,UAC7CA,OAAOpD,cAAc,iCAErBmD,aAAaE,SACjCF,aAAaE,QAAQD,OAAOpD,cAAc,mBAIvD,iBAMTJ,UAAW6C,MAAAA,sCAAAA,UAAWa,QAAQ/D,0FAAmCgD,aAAa,mBAAoB,GAClG1C,UAAW4C,MAAAA,uCAAAA,UAAWa,QAAQ/D,4FAAmCgD,aAAa,mBAAoB,IAEnG/C,aAAeI,SAASW,OAAS,GAElC0C,YAAW,MACPzD,YAAc,IAAI+D,qBACdd,UACAX,UACAf,SAIAvB,YAAY4C,iBAAiB5C,YAAYgE,OAAOC,gBAAgB,KAC5DjE,YAAc,KAEdG,SAASC,SAAUC,SAAUJ,gBAGjCD,YAAY4C,iBAAiB5C,YAAYgE,OAAOE,yBAAyB,KAGhEjE,YAAc,GAAMC,cACrBF,YAAc,KACdG,SAASC,SAAUC,SAAUJ,cAE7BA,YAAcC,mBAI3B,KArHPiE,CAFkB5B,mBAAmB/B,cAAcT,yBAEzBuC,UAAWE"}